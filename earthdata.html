<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NASA + OpenAQ Air Quality & Health Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #001f3f;
  color: white;
}
header {
  background: #002b5c;
  padding: 0.5rem 1rem;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
header h1 { margin: 0.3rem 0; font-size: 1.3rem; }
.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 0.3rem;
}
select, button {
  padding: 0.4rem 0.6rem;
  border: none;
  border-radius: 4px;
  background: #0066cc;
  color: white;
  cursor: pointer;
}
select:hover, button:hover { background: #004c99; }
.range-container {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
}
input[type=range] { width: 150px; cursor: pointer; }
#map { height: calc(100vh - 180px); width: 100%; }
#coords {
  background: rgba(0,0,0,0.6);
  position: absolute;
  bottom: 10px;
  left: 10px;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 0.9rem;
}
#legend, #pollutant-info {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(0,0,0,0.7);
  padding: 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  line-height: 1.2rem;
}
#legend div {
  height: 12px;
  width: 60px;
  display: inline-block;
  margin: 2px;
}
#pollutant-info {
  right: 190px;
  width: 300px;
  overflow-y: auto;
  max-height: 260px;
}
#pollutantDesc b { color: #66ccff; }
</style>
</head>
<body>
<header>
  <h1>NASA + OpenAQ Air Quality & Health Dashboard</h1>
  <div class="controls">
    <select id="citySelect" onchange="goToCity()">
      <option value="">Choose City</option>
      <option value="34.05,-118.24">Los Angeles</option>
      <option value="40.71,-74.00">New York City</option>
      <option value="51.50,-0.12">London</option>
      <option value="36.17,-115.14">Las Vegas</option>
      <option value="25.76,-80.19">Miami</option>
    </select>

    <select id="overlaySelect" onchange="toggleOverlay()">
      <option value="">No Overlay</option>
      <option value="MODIS_Terra_Aerosol">Aerosol Index (AI)</option>
      <option value="MOPITT_CO_Monthly_Total_Column_Day">Carbon Monoxide (CO)</option>
    </select>

    <div class="range-container">
      Opacity:
      <input type="range" id="opacityRange" min="0" max="1" step="0.05" value="0.6" oninput="updateOpacity()">
      <span id="opacityVal">0.6</span>
    </div>

    <button onclick="toggleTemp()">Toggle Temperature</button>
    <button onclick="toggleAirSensors()">Toggle Air Sensors</button>
    <button onclick="locate()">My Location</button>
  </div>
</header>

<div id="map"></div>
<div id="coords">Lat: -- , Lon: --</div>

<div id="legend">
  <strong>Temperature (°C)</strong><br>
  <div style="background:blue"></div><span>&lt;10</span>
  <div style="background:yellow"></div><span>10–25</span>
  <div style="background:red"></div><span>&gt;25</span>
</div>

<div id="pollutant-info">
  <strong>Chemical Info</strong>
  <div id="pollutantDesc">
    Select a pollutant or overlay to learn its causes and health effects.
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, baseLayer, overlayLayer, tempLayer, sensorLayer;
const today = new Date();
const iso = today.toISOString().split('T')[0];

map = L.map('map', { center: [20, 0], zoom: 3 });
baseLayer = L.tileLayer(
  `https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${iso}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
  { maxZoom: 9, subdomains: 'abc', attribution: 'Imagery: NASA GIBS' }
).addTo(map);

// Info for pollutants
const pollutantInfo = {
  "AI": {
    name: "Aerosol Index (AI)",
    cause: "Dust, smoke, and pollution particles from fires, deserts, and industrial emissions.",
    risk: "Inhalation causes respiratory irritation, worsens asthma, and increases cardiovascular strain."
  },
  "CO": {
    name: "Carbon Monoxide (CO)",
    cause: "Incomplete fuel combustion from vehicles, industry, and fires.",
    risk: "Reduces oxygen delivery to the body; causes dizziness, fatigue, and risk to heart and brain."
  },
  "NO2": {
    name: "Nitrogen Dioxide (NO₂)",
    cause: "Emitted by vehicles, power plants, and industrial combustion.",
    risk: "Irritates lungs, reduces immunity to infections, and contributes to ozone formation."
  },
  "CH2O": {
    name: "Formaldehyde (CH₂O or HCHO)",
    cause: "Released by fires, industrial emissions, and chemical manufacturing.",
    risk: "Causes eye and throat irritation and is classified as a human carcinogen."
  },
  "PM25": {
    name: "Particulate Matter (PM₂.₅)",
    cause: "Fine particles from combustion, vehicles, and dust.",
    risk: "Penetrates deep into lungs and bloodstream; linked to heart and lung disease."
  },
  "O3": {
    name: "Ozone (O₃)",
    cause: "Forms from NOx and VOCs reacting in sunlight.",
    risk: "Triggers asthma, reduces lung function, and causes chest pain and coughing."
  }
};

function toggleOverlay() {
  const val = document.getElementById('overlaySelect').value;
  const infoBox = document.getElementById('pollutantDesc');
  if (overlayLayer) map.removeLayer(overlayLayer);
  if (!val) { infoBox.textContent = "No overlay selected."; return; }

  const opacity = parseFloat(document.getElementById('opacityRange').value);
  overlayLayer = L.tileLayer(
    `https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/${val}/default/${iso}/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png`,
    { maxZoom: 6, subdomains: 'abc', opacity, attribution: 'NASA GIBS Overlay' }
  ).addTo(map);

  const key = val.includes("Aerosol") ? "AI" : val.includes("CO") ? "CO" : null;
  if (key) {
    const p = pollutantInfo[key];
    infoBox.innerHTML = `<b>${p.name}</b><br><b>Caused by:</b> ${p.cause}<br><b>Health Risk:</b> ${p.risk}`;
  }
}

function updateOpacity(){
  const val = parseFloat(document.getElementById('opacityRange').value);
  document.getElementById('opacityVal').textContent = val.toFixed(2);
  if (overlayLayer) overlayLayer.setOpacity(val);
}

function goToCity() {
  const val = document.getElementById('citySelect').value;
  if (!val) return;
  const [lat, lon] = val.split(',').map(Number);
  map.setView([lat, lon], 6);
  if (tempLayer) map.removeLayer(tempLayer);
  if (sensorLayer) map.removeLayer(sensorLayer);
}

async function toggleTemp(){
  if (tempLayer) { map.removeLayer(tempLayer); tempLayer=null; return; }
  const c = map.getCenter();
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lng}&hourly=temperature_2m&forecast_days=1`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const temps = data.hourly.temperature_2m.slice(0, 24);
    tempLayer = L.layerGroup();

    for (let i=0; i<temps.length; i+=2){
      const temp = temps[i];
      const color = temp < 10 ? "blue" : temp < 25 ? "yellow" : "red";
      const latOff = (Math.random()-0.5)*3;
      const lonOff = (Math.random()-0.5)*3;
      const rect = L.rectangle([
        [c.lat+latOff-0.2, c.lng+lonOff-0.2],
        [c.lat+latOff+0.2, c.lng+lonOff+0.2]
      ], {color, fillColor:color, weight:1, fillOpacity:0.5});
      rect.bindPopup(`Temperature: ${temp.toFixed(1)}°C`);
      tempLayer.addLayer(rect);
    }
    tempLayer.addTo(map);
  } catch(err) {
    alert("Temperature data unavailable.");
    console.error(err);
  }
}

async function toggleAirSensors(){
  if (sensorLayer) { map.removeLayer(sensorLayer); sensorLayer=null; return; }
  const c = map.getCenter();
  const url = `https://api.openaq.org/v2/latest?coordinates=${c.lat},${c.lng}&radius=50000&limit=50`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    sensorLayer = L.layerGroup();
    data.results.forEach(site => {
      const { coordinates, measurements, city } = site;
      if (!coordinates) return;
      const main = measurements[0];
      const color = main.parameter === "pm25" ? "purple" :
                    main.parameter === "no2" ? "orange" :
                    main.parameter === "o3" ? "green" :
                    main.parameter === "ch2o" ? "pink" : "gray";
      const circle = L.circleMarker([coordinates.latitude, coordinates.longitude], {
        radius: 6, color, fillColor: color, fillOpacity: 0.8
      }).bindPopup(`<b>${city || "Station"}</b><br>${main.parameter.toUpperCase()}: ${main.value} ${main.unit}`);
      sensorLayer.addLayer(circle);
    });
    sensorLayer.addTo(map);

    const p = pollutantInfo;
    document.getElementById('pollutantDesc').innerHTML = `
      <b>Ground Pollutants (OpenAQ)</b><br>
      <b>${p.PM25.name}</b> – ${p.PM25.cause}<br><i>${p.PM25.risk}</i><br><br>
      <b>${p.NO2.name}</b> – ${p.NO2.cause}<br><i>${p.NO2.risk}</i><br><br>
      <b>${p.O3.name}</b> – ${p.O3.cause}<br><i>${p.O3.risk}</i><br><br>
      <b>${p.CH2O.name}</b> – ${p.CH2O.cause}<br><i>${p.CH2O.risk}</i>
    `;
  } catch(err){
    alert("Air sensor data unavailable.");
    console.error(err);
  }
}

map.on('move', () => {
  const c = map.getCenter();
  document.getElementById('coords').textContent =
    `Lat: ${c.lat.toFixed(3)}, Lon: ${c.lng.toFixed(3)}`;
});

function locate(){
  if(!navigator.geolocation) return alert("No geolocation support.");
  navigator.geolocation.getCurrentPosition(pos=>{
    map.setView([pos.coords.latitude, pos.coords.longitude], 6);
  });
}
</script>
</body>
</html>
